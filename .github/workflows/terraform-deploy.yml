name: 'Terraform Deploy'

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/azure/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan

concurrency:
  group: terraform-deploy-${{ github.event.inputs.environment || 'all' }}
  cancel-in-progress: false

env:
  TF_LOG: INFO
  TF_INPUT: false

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read

jobs:
  # ============================================
  # DEV ENVIRONMENT - Auto Deploy
  # ============================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
      url: https://dev.yourapp.azure.com
    outputs:
      plan_exitcode: ${{ steps.terraform.outputs.plan-exitcode }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Dev
        id: terraform
        uses: ./.github/actions/terraform-azure
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          environment: dev
          operation: ${{ github.event.inputs.action || 'apply' }}
          auto-approve: 'true'
          backend-resource-group: ${{ vars.TF_BACKEND_RESOURCE_GROUP }}
          backend-storage-account: ${{ vars.TF_BACKEND_STORAGE_ACCOUNT }}
          enable-security-scan: 'true'
          enable-cost-estimation: 'true'
          infracost-api-key: ${{ secrets.INFRACOST_API_KEY }}
          github-token: ${{ secrets.MY_TOKEN }}
          plan-title: 'ðŸš€ Dev Deployment'
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on Success
        if: success()
        run: |
          echo "âœ… Dev deployment completed successfully"
          # Add Slack/Teams notification here

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Dev deployment failed"
          # Add Slack/Teams notification here

  # ============================================
  # STAGING ENVIRONMENT - Requires Dev Success
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: |
      (github.event_name == 'push' && needs.deploy-dev.result == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.yourapp.azure.com
    outputs:
      plan_exitcode: ${{ steps.terraform.outputs.plan-exitcode }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Staging
        id: terraform
        uses: ./.github/actions/terraform-azure
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          environment: staging
          operation: ${{ github.event.inputs.action || 'apply' }}
          auto-approve: 'true'
          backend-resource-group: ${{ vars.TF_BACKEND_RESOURCE_GROUP }}
          backend-storage-account: ${{ vars.TF_BACKEND_STORAGE_ACCOUNT }}
          enable-security-scan: 'true'
          enable-cost-estimation: 'true'
          infracost-api-key: ${{ secrets.INFRACOST_API_KEY }}
          github-token: ${{ secrets.MY_TOKEN }}
          plan-title: 'ðŸš€ Staging Deployment'
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Integration Tests
        if: success()
        run: |
          echo "ðŸ§ª Running integration tests against staging..."
          # Add your integration test commands here
          # curl -f https://staging.yourapp.azure.com/health || exit 1

  # ============================================
  # PRODUCTION ENVIRONMENT - Manual Approval Required
  # ============================================
  plan-prod:
    name: Plan Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: |
      (github.event_name == 'push' && needs.deploy-staging.result == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod' && github.event.inputs.action == 'plan')
    outputs:
      plan_exitcode: ${{ steps.terraform.outputs.plan-exitcode }}
      resources_changed: ${{ steps.terraform.outputs.resources-changed }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Plan Production
        id: terraform
        uses: ./.github/actions/terraform-azure
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          environment: prod
          operation: plan
          backend-resource-group: ${{ vars.TF_BACKEND_RESOURCE_GROUP }}
          backend-storage-account: ${{ vars.TF_BACKEND_STORAGE_ACCOUNT }}
          enable-security-scan: 'true'
          enable-cost-estimation: 'true'
          infracost-api-key: ${{ secrets.INFRACOST_API_KEY }}
          github-token: ${{ secrets.MY_TOKEN }}
          plan-title: 'ðŸ­ Production Plan'
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Check for Changes
        id: check-changes
        run: |
          if [ "${{ steps.terraform.outputs.plan-exitcode }}" == "0" ]; then
            echo "No changes detected for production"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected for production - requires approval"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: plan-prod
    if: |
      needs.plan-prod.outputs.plan_exitcode == '2' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod' && github.event.inputs.action == 'apply')
    environment:
      name: production
      url: https://yourapp.azure.com
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Production Deployment Notice
        run: |
          echo "âš ï¸ PRODUCTION DEPLOYMENT"
          echo "========================"
          echo "This deployment has been approved through GitHub Environment protection rules"
          echo "Deployer: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Deploy to Production
        id: terraform
        uses: ./.github/actions/terraform-azure
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          environment: prod
          operation: apply
          auto-approve: 'true'
          backend-resource-group: ${{ vars.TF_BACKEND_RESOURCE_GROUP }}
          backend-storage-account: ${{ vars.TF_BACKEND_STORAGE_ACCOUNT }}
          enable-security-scan: 'false'  # Already scanned in plan
          github-token: ${{ secrets.MY_TOKEN }}
          plan-title: 'ðŸ­ Production Deployment'
          lock-timeout: '10m'
          parallelism: '5'  # Lower parallelism for safety
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Production Health Check
        if: success()
        run: |
          echo "ðŸ¥ Running production health checks..."
          # Add health check commands
          # for i in {1..5}; do
          #   curl -sf https://yourapp.azure.com/health && exit 0
          #   sleep 10
          # done
          # exit 1

      - name: Create Deployment Record
        if: always()
        run: |
          echo "ðŸ“ Creating deployment record..."
          echo "Status: ${{ job.status }}"
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          # Add to deployment tracking system

  # ============================================
  # DEPLOYMENT SUMMARY
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-staging, plan-prod]
    if: always() && github.event_name == 'push'
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | ${{ needs.deploy-dev.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.deploy-staging.result == 'success' && 'âœ…' || needs.deploy-staging.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod (Plan) | ${{ needs.plan-prod.result == 'success' && 'âœ…' || needs.plan-prod.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
