name: 'Terraform Azure Composite'
description: 'Production-grade Terraform workflow for Azure with OIDC, security scanning, cost estimation, and PR automation'
author: 'DevOps Team'

inputs:
  # Authentication - OIDC (Recommended)
  azure-client-id:
    description: 'Azure AD Application (client) ID for OIDC'
    required: false
  azure-tenant-id:
    description: 'Azure AD Tenant ID'
    required: true
  azure-subscription-id:
    description: 'Azure Subscription ID'
    required: true
  
  # Authentication - Service Principal (Legacy)
  azure-client-secret:
    description: 'Azure AD Application client secret (use OIDC instead)'
    required: false
  
  # Terraform Configuration
  environment:
    description: 'Target environment (dev, staging, prod)'
    required: true
    default: 'dev'
  working-directory:
    description: 'Directory containing Terraform configuration'
    required: false
    default: './infrastructure/azure/environments'
  terraform-version:
    description: 'Terraform version to use'
    required: false
    default: '1.6.6'
  
  # Operation Mode
  operation:
    description: 'Operation to perform: plan, apply, destroy, drift-detect'
    required: true
    default: 'plan'
  
  # State Backend
  backend-resource-group:
    description: 'Resource group for Terraform state storage'
    required: true
  backend-storage-account:
    description: 'Storage account for Terraform state'
    required: true
  backend-container:
    description: 'Blob container for Terraform state'
    required: false
    default: 'tfstate'
  backend-key:
    description: 'State file key/path'
    required: false
  
  # Security & Quality
  enable-security-scan:
    description: 'Enable tfsec and checkov security scanning'
    required: false
    default: 'true'
  enable-cost-estimation:
    description: 'Enable Infracost cost estimation'
    required: false
    default: 'true'
  infracost-api-key:
    description: 'Infracost API key for cost estimation'
    required: false
  
  # PR Integration
  github-token:
    description: 'GitHub token for PR comments'
    required: true
  plan-title:
    description: 'Title for plan comment on PR'
    required: false
    default: 'Terraform Plan'
  
  # Additional Options
  terraform-vars:
    description: 'Additional Terraform variables in JSON format'
    required: false
    default: '{}'
  terraform-var-files:
    description: 'Comma-separated list of .tfvars files'
    required: false
  auto-approve:
    description: 'Auto-approve apply/destroy (use with caution)'
    required: false
    default: 'false'
  lock-timeout:
    description: 'State lock timeout duration'
    required: false
    default: '5m'
  parallelism:
    description: 'Limit the number of concurrent operations'
    required: false
    default: '10'
  
  # Secrets (passed as TF_VAR_*)
  slack-webhook-url:
    description: 'Slack webhook URL for alerts (sensitive - passed as TF_VAR)'
    required: false
    default: ''

outputs:
  plan-exitcode:
    description: 'Terraform plan exit code (0=no changes, 2=changes)'
    value: ${{ steps.plan.outputs.exitcode }}
  plan-stdout:
    description: 'Terraform plan output'
    value: ${{ steps.plan.outputs.stdout }}
  apply-exitcode:
    description: 'Terraform apply exit code'
    value: ${{ steps.apply.outputs.exitcode }}
  cost-monthly:
    description: 'Estimated monthly cost from Infracost'
    value: ${{ steps.infracost.outputs.monthly_cost }}
  drift-detected:
    description: 'Whether drift was detected'
    value: ${{ steps.drift.outputs.drift_detected }}
  resources-changed:
    description: 'Number of resources to be changed'
    value: ${{ steps.plan-summary.outputs.resources_changed }}

branding:
  icon: 'cloud'
  color: 'blue'

runs:
  using: 'composite'
  steps:
    # ============================================
    # SETUP PHASE
    # ============================================
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform-version }}
        terraform_wrapper: true

    - name: Cache Terraform Plugins
      uses: actions/cache@v4
      with:
        path: |
          ~/.terraform.d/plugin-cache
          ${{ inputs.working-directory }}/${{ inputs.environment }}/.terraform
        key: terraform-${{ runner.os }}-${{ inputs.environment }}-${{ hashFiles('**/*.tf') }}
        restore-keys: |
          terraform-${{ runner.os }}-${{ inputs.environment }}-
          terraform-${{ runner.os }}-

    - name: Configure Terraform Plugin Cache
      shell: bash
      run: |
        mkdir -p ~/.terraform.d/plugin-cache
        echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

    # ============================================
    # AZURE AUTHENTICATION
    # ============================================
    - name: Azure Login (OIDC)
      if: inputs.azure-client-secret == ''
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.azure-client-id }}
        tenant-id: ${{ inputs.azure-tenant-id }}
        subscription-id: ${{ inputs.azure-subscription-id }}

    - name: Azure Login (Service Principal)
      if: inputs.azure-client-secret != ''
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ inputs.azure-client-id }}",
            "clientSecret": "${{ inputs.azure-client-secret }}",
            "subscriptionId": "${{ inputs.azure-subscription-id }}",
            "tenantId": "${{ inputs.azure-tenant-id }}"
          }

    - name: Set Azure Environment Variables
      shell: bash
      run: |
        # Set ARM environment variables for Terraform
        echo "ARM_CLIENT_ID=${{ inputs.azure-client-id }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ inputs.azure-tenant-id }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ inputs.azure-subscription-id }}" >> $GITHUB_ENV
        
        # For OIDC
        if [ -z "${{ inputs.azure-client-secret }}" ]; then
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV
        else
          echo "ARM_CLIENT_SECRET=${{ inputs.azure-client-secret }}" >> $GITHUB_ENV
        fi

    # ============================================
    # CODE QUALITY CHECKS
    # ============================================
    - name: Terraform Format Check
      id: fmt
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        terraform fmt -check -recursive -diff
      continue-on-error: true

    - name: Setup TFLint
      if: inputs.enable-security-scan == 'true'
      uses: terraform-linters/setup-tflint@v4
      with:
        tflint_version: latest

    - name: Initialize TFLint
      if: inputs.enable-security-scan == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: tflint --init
      continue-on-error: true

    - name: Run TFLint
      id: tflint
      if: inputs.enable-security-scan == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        tflint --format=compact --recursive
      continue-on-error: true

    # ============================================
    # SECURITY SCANNING
    # ============================================
    - name: Run tfsec
      id: tfsec
      if: inputs.enable-security-scan == 'true'
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
        soft_fail: true
        format: sarif
        out: tfsec-results.sarif
      continue-on-error: true

    - name: Upload tfsec SARIF
      if: inputs.enable-security-scan == 'true' && always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: tfsec-results.sarif
      continue-on-error: true

    - name: Run Checkov
      id: checkov
      if: inputs.enable-security-scan == 'true'
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
        framework: terraform
        output_format: cli,sarif
        output_file_path: console,checkov-results.sarif
        soft_fail: true
        skip_check: CKV_AZURE_35,CKV_AZURE_36  # Customize as needed
      continue-on-error: true

    # ============================================
    # TERRAFORM INIT
    # ============================================
    - name: Determine Backend Key
      id: backend-key
      shell: bash
      run: |
        if [ -n "${{ inputs.backend-key }}" ]; then
          echo "key=${{ inputs.backend-key }}" >> $GITHUB_OUTPUT
        else
          echo "key=${{ inputs.environment }}/terraform.tfstate" >> $GITHUB_OUTPUT
        fi

    - name: Terraform Init
      id: init
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ inputs.backend-resource-group }}" \
          -backend-config="storage_account_name=${{ inputs.backend-storage-account }}" \
          -backend-config="container_name=${{ inputs.backend-container }}" \
          -backend-config="key=${{ steps.backend-key.outputs.key }}" \
          -input=false \
          -no-color

    - name: Terraform Workspace
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}

    - name: Terraform Validate
      id: validate
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: terraform validate -no-color

    # ============================================
    # TERRAFORM PLAN
    # ============================================
    - name: Build Terraform Variables
      id: tf-vars
      shell: bash
      run: |
        VAR_ARGS=""
        
        # Add JSON variables
        if [ '${{ inputs.terraform-vars }}' != '{}' ]; then
          echo '${{ inputs.terraform-vars }}' | jq -r 'to_entries[] | "-var \(.key)=\(.value)"' | while read line; do
            VAR_ARGS="$VAR_ARGS $line"
          done
        fi
        
        # Add var files
        if [ -n "${{ inputs.terraform-var-files }}" ]; then
          IFS=',' read -ra FILES <<< "${{ inputs.terraform-var-files }}"
          for file in "${FILES[@]}"; do
            VAR_ARGS="$VAR_ARGS -var-file=$file"
          done
        fi
        
        echo "var_args=$VAR_ARGS" >> $GITHUB_OUTPUT

    - name: Terraform Plan
      id: plan
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      env:
        TF_VAR_slack_webhook_url: ${{ inputs.slack-webhook-url }}
      run: |
        set +e
        
        terraform plan \
          -input=false \
          -no-color \
          -out=tfplan.binary \
          -lock-timeout=${{ inputs.lock-timeout }} \
          -parallelism=${{ inputs.parallelism }} \
          -detailed-exitcode \
          ${{ steps.tf-vars.outputs.var_args }} \
          2>&1 | tee plan_output.txt
        
        PLAN_EXIT_CODE=${PIPESTATUS[0]}
        echo "exitcode=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Convert binary plan to JSON for analysis
        terraform show -json tfplan.binary > tfplan.json
        
        # Exit code: 0 = no changes, 1 = error, 2 = changes present
        if [ $PLAN_EXIT_CODE -eq 1 ]; then
          echo "::error::Terraform plan failed"
          exit 1
        fi

    - name: Analyze Plan Changes
      id: plan-summary
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        # Extract change summary from plan JSON
        if [ -f tfplan.json ]; then
          ADD=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"]))] | length' tfplan.json)
          CHANGE=$(jq '[.resource_changes[]? | select(.change.actions | contains(["update"]))] | length' tfplan.json)
          DESTROY=$(jq '[.resource_changes[]? | select(.change.actions | contains(["delete"]))] | length' tfplan.json)
          
          echo "resources_add=$ADD" >> $GITHUB_OUTPUT
          echo "resources_change=$CHANGE" >> $GITHUB_OUTPUT
          echo "resources_destroy=$DESTROY" >> $GITHUB_OUTPUT
          echo "resources_changed=$((ADD + CHANGE + DESTROY))" >> $GITHUB_OUTPUT
          
          # Create human-readable summary
          echo "### ğŸ“Š Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¢ Add | $ADD |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¡ Change | $CHANGE |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”´ Destroy | $DESTROY |" >> $GITHUB_STEP_SUMMARY
        fi

    # ============================================
    # COST ESTIMATION
    # ============================================
    - name: Setup Infracost
      if: inputs.enable-cost-estimation == 'true' && inputs.infracost-api-key != ''
      uses: infracost/actions/setup@v3
      with:
        api-key: ${{ inputs.infracost-api-key }}

    - name: Generate Infracost Report
      id: infracost
      if: inputs.enable-cost-estimation == 'true' && inputs.infracost-api-key != ''
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        infracost breakdown \
          --path=tfplan.json \
          --format=json \
          --out-file=/tmp/infracost.json
        
        MONTHLY_COST=$(jq -r '.totalMonthlyCost' /tmp/infracost.json)
        echo "monthly_cost=$MONTHLY_COST" >> $GITHUB_OUTPUT
        
        # Add to summary
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ’° Cost Estimation" >> $GITHUB_STEP_SUMMARY
        echo "Estimated monthly cost: **\$$MONTHLY_COST**" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Post Infracost Comment
      if: inputs.enable-cost-estimation == 'true' && inputs.infracost-api-key != '' && github.event_name == 'pull_request'
      uses: infracost/actions/comment@v1
      with:
        path: /tmp/infracost.json
        behavior: update
      continue-on-error: true

    # ============================================
    # PR COMMENT
    # ============================================
    - name: Generate Plan Output
      id: plan-output
      if: github.event_name == 'pull_request'
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        terraform show -no-color tfplan.binary > /tmp/plan_readable.txt

    - name: Post Plan to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const planOutput = fs.readFileSync('/tmp/plan_readable.txt', 'utf8');
          
          // Truncate if too long
          const maxLength = 60000;
          const truncatedPlan = planOutput.length > maxLength 
            ? planOutput.substring(0, maxLength) + '\n\n... (truncated, see workflow logs for full output)'
            : planOutput;
          
          const fmtResult = '${{ steps.fmt.outcome }}' === 'success' ? 'âœ…' : 'âš ï¸';
          const initResult = '${{ steps.init.outcome }}' === 'success' ? 'âœ…' : 'âŒ';
          const validateResult = '${{ steps.validate.outcome }}' === 'success' ? 'âœ…' : 'âŒ';
          const planResult = '${{ steps.plan.outcome }}' === 'success' ? 'âœ…' : 'âŒ';
          const tfsecResult = '${{ steps.tfsec.outcome }}' === 'success' ? 'âœ…' : 'âš ï¸';
          
          const addCount = '${{ steps.plan-summary.outputs.resources_add }}' || '0';
          const changeCount = '${{ steps.plan-summary.outputs.resources_change }}' || '0';
          const destroyCount = '${{ steps.plan-summary.outputs.resources_destroy }}' || '0';
          
          const body = `## ${{ inputs.plan-title }} - \`${{ inputs.environment }}\` Environment
          
          ### Workflow Status
          | Step | Status |
          |------|--------|
          | ğŸ–Œï¸ Format | ${fmtResult} |
          | âš™ï¸ Init | ${initResult} |
          | âœ… Validate | ${validateResult} |
          | ğŸ“– Plan | ${planResult} |
          | ğŸ”’ Security Scan | ${tfsecResult} |
          
          ### Resource Changes
          | Action | Count |
          |--------|-------|
          | ğŸŸ¢ Create | ${addCount} |
          | ğŸŸ¡ Update | ${changeCount} |
          | ğŸ”´ Delete | ${destroyCount} |
          
          <details>
          <summary>ğŸ“‹ Show Full Plan</summary>
          
          \`\`\`hcl
          ${truncatedPlan}
          \`\`\`
          
          </details>
          
          ---
          *Triggered by @${{ github.actor }} | Workflow: \`${{ github.workflow }}\` | [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('${{ inputs.plan-title }}') &&
            comment.body.includes('${{ inputs.environment }}')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    # ============================================
    # DRIFT DETECTION
    # ============================================
    - name: Detect Drift
      id: drift
      if: inputs.operation == 'drift-detect'
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        if [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
          echo "drift_detected=true" >> $GITHUB_OUTPUT
          echo "::warning::Infrastructure drift detected!"
          
          # Create drift report
          echo "## ğŸ”„ Drift Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âš ï¸ Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        else
          echo "drift_detected=false" >> $GITHUB_OUTPUT
          echo "## ğŸ”„ Drift Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… No Drift" >> $GITHUB_STEP_SUMMARY
        fi

    # ============================================
    # TERRAFORM APPLY
    # ============================================
    - name: Terraform Apply
      id: apply
      if: inputs.operation == 'apply' && (inputs.auto-approve == 'true' || (github.ref == 'refs/heads/main' && github.event_name == 'push'))
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      env:
        TF_VAR_slack_webhook_url: ${{ inputs.slack-webhook-url }}
      run: |
        set +e

        # Only apply if there are changes
        if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
          echo "No changes to apply"
          echo "exitcode=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        terraform apply \
          -input=false \
          -no-color \
          -auto-approve \
          -lock-timeout=${{ inputs.lock-timeout }} \
          -parallelism=${{ inputs.parallelism }} \
          tfplan.binary 2>&1 | tee apply_output.txt
        
        APPLY_EXIT_CODE=${PIPESTATUS[0]}
        echo "exitcode=$APPLY_EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $APPLY_EXIT_CODE -ne 0 ]; then
          echo "::error::Terraform apply failed"
          exit 1
        fi
        
        echo "### âœ… Apply Completed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "Environment: **${{ inputs.environment }}**" >> $GITHUB_STEP_SUMMARY

    # ============================================
    # TERRAFORM DESTROY
    # ============================================
    - name: Terraform Destroy
      id: destroy
      if: inputs.operation == 'destroy'
      shell: bash
      working-directory: ${{ inputs.working-directory }}/${{ inputs.environment }}
      run: |
        set +e
        
        if [ "${{ inputs.auto-approve }}" != "true" ]; then
          echo "::error::Destroy requires auto-approve=true for safety"
          exit 1
        fi
        
        terraform destroy \
          -input=false \
          -no-color \
          -auto-approve \
          -lock-timeout=${{ inputs.lock-timeout }} \
          -parallelism=${{ inputs.parallelism }} \
          ${{ steps.tf-vars.outputs.var_args }} 2>&1 | tee destroy_output.txt
        
        DESTROY_EXIT_CODE=${PIPESTATUS[0]}
        echo "exitcode=$DESTROY_EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $DESTROY_EXIT_CODE -ne 0 ]; then
          echo "::error::Terraform destroy failed"
          exit 1
        fi
        
        echo "### ğŸ—‘ï¸ Destroy Completed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "Environment: **${{ inputs.environment }}**" >> $GITHUB_STEP_SUMMARY

    # ============================================
    # CLEANUP & ARTIFACTS
    # ============================================
    - name: Upload Plan Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-${{ inputs.environment }}-${{ github.run_number }}
        path: |
          ${{ inputs.working-directory }}/${{ inputs.environment }}/tfplan.json
          ${{ inputs.working-directory }}/${{ inputs.environment }}/plan_output.txt
        retention-days: 30
      continue-on-error: true

    - name: Final Status
      if: always()
      shell: bash
      run: |
        echo "### ğŸ“‹ Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Operation | ${{ inputs.operation }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Terraform Version | ${{ inputs.terraform-version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Runner | ${{ runner.os }} |" >> $GITHUB_STEP_SUMMARY
